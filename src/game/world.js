const WORLD_HEIGHT = 50;
const WORLD_WIDTH = 128;
const TILE_SIZE = 32;

class Tile {
    constructor(type, darkness) {
        this.type = type;
        this.darkness = darkness;
    }
}

class World {
    constructor() {
        this.isLoaded = false;
        this.cameraPosition = createVector(0, 0);

        this.tiles = [];
        for (let x = 0; x < WORLD_WIDTH; x++) {
            this.tiles[x] = [];
        }

        this.loadLevel();
    }

    updateCameraPosition(position){
        this.cameraPosition = position;
    }

    async loadLevel() {
        const levelData = '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00002222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222000000000000000000000000\n'+
        '00002222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222211110000000000000000000\n'+
        '00002222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222211111000000000000000000\n'+
        '00002222111111111111111111131111111111111311111111111111111111111111111111111111111111111111111111111111111111100000000000000000\n'+
        '00002221111111111111111111131111111111111311111111111111111111111111111111111111111111111111111111111111111111111100000000000000\n'+
        '00002221111111111111111111131111111111111311111111111111111111111111111111111111111111111111111111111111111111111111000000000000\n'+
        '00002221111111111111111111131111111111111311111111111111111111111111111111111111111111111111111111111111111111111111100000000000\n'+
        '00002221111111111111111111131111111111111311111111111111111111111111111111111111111111111111111111111111111111111111110000000000\n'+
        '00002221111111111111111111131111111111111311111111111111111111111111111111111111111111111111111111111111111111111111111000000000\n'+
        '00002221111111111111111111131111111111111311111111111111111111111111111111111111111111111111111111111111111111111111111100000000\n'+
        '00002221111111111111111111131111111111111311111111111111111111111111111111111111111111111111111111111111111111111111111100000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000\n'+
        '00002221111111111111111111111111111111111111111111111133333333333333333111111111111111111111111111111111111111111111111110000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000\n'+
        '00002221111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000\n'+
        '00002222111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000\n'+
        '00002222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222211111100000000000000000\n'+
        '00002222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222211100000000000000000000\n'+
        '00000222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222200000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n'+
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001\n';
        const rows = levelData.split('\n');
        for (let y = 0; y < WORLD_HEIGHT; y++) {
            const row = rows[y];
            for (let x = 0; x < WORLD_WIDTH; x++) {
                const typeNumber = row.charAt(x);
                this.tiles[x][y] = new Tile(typeNumber, random(30));
            }
        }

        this.isLoaded = true;
    }

    clamp(value, minimumValue, maximumValue){
        return Math.min(Math.max(value, minimumValue), maximumValue);
    }

    draw() {
        if (!this.isLoaded) {
            background(0);
            return;
        }
        let bla = createVector(this.cameraPosition.x + (WORLD_WIDTH / 2) * TILE_SIZE, this.cameraPosition.y + (WORLD_HEIGHT / 2) * TILE_SIZE, )
        let tileIndexCameraX = Math.floor(bla.x / TILE_SIZE);
        let tileIndexCameraY = Math.floor(bla.y / TILE_SIZE);
        let tileXStartIndex = this.clamp(tileIndexCameraX - 20, 0, WORLD_WIDTH -1);
        let tileXEndIndex = this.clamp(tileIndexCameraX + 20, 0, WORLD_WIDTH -1);
        let tileYStartIndex = this.clamp(tileIndexCameraY - 20, 0, WORLD_HEIGHT - 1);
        let tileYEndIndex = this.clamp(tileIndexCameraY + 20, 0, WORLD_HEIGHT -1);
        for (let x = tileXStartIndex; x < tileXEndIndex; x++) {
            for (let y = tileYStartIndex; y < tileYEndIndex; y++) {
                let drawX = x * TILE_SIZE - (WORLD_WIDTH / 2) * TILE_SIZE;
                let drawY = y * TILE_SIZE - (WORLD_HEIGHT / 2) * TILE_SIZE;
                const type = this.tiles[x][y].type;
                const darkness = this.tiles[x][y].darkness;
                let colorValue = color(0);
                switch (type) {
                    case '0':
                        colorValue = color(0,0,200);
                            break;
                    case '1':
                        colorValue = color(40);
                        break;
                    case '2':
                        colorValue = color(80);
                        break;
                    case '3':
                        colorValue = color(200, 200, 50);
                        break;
                }
                push();
                rectMode(CORNER);
                colorMode(HSL, 255);

                strokeWeight(2);
                stroke(darkness + 80);

                lightness(darkness);
                fill(colorValue);

                rect(drawX, drawY, TILE_SIZE, TILE_SIZE);

                pop();
            }
        }
    }
}